// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== ENUMS ==============

enum UserRole {
  admin
  regionalDirector
  areaManager
  branchManager
  lineManager
  subTeamLeader
  staff
}

enum Position {
  Regional_Director          @map("Regional Director")
  Area_Manager               @map("Area Manager")
  Branch_Manager             @map("Branch Manager")
  Member_Service_Manager     @map("Member Service Manager (MSM)")
  Accountant
  Member_Service_Officer_I   @map("Member Service Officer I")
  Member_Service_Officer_II  @map("Member Service Officer II")
  Member_Service_Officer_III @map("Member Service Officer III")
}

enum KpiCategory {
  Deposit_Mobilization     @map("Deposit Mobilization")
  Digital_Channel_Growth   @map("Digital Channel Growth")
  Member_Registration      @map("Member Registration")
  Shareholder_Recruitment  @map("Shareholder Recruitment")
  Loan_NPL                 @map("Loan & NPL")
  Customer_Base            @map("Customer Base")
}

enum PlanPeriod {
  H2_2025       @map("2025-H2")
  Q4_2025       @map("Q4-2025")
  December_2025 @map("December-2025")
  Year_2025     @map("2025")
}

enum PlanStatus {
  Draft
  Active
  Completed
  Cancelled
}

enum TargetType {
  incremental
}

enum AccountType {
  Savings
  Current
  Fixed_Deposit     @map("Fixed Deposit")
  Recurring_Deposit @map("Recurring Deposit")
  Loan
}

enum AccountStatus {
  Active
  Inactive
  Transferred
}

enum TaskType {
  Deposit_Mobilization     @map("Deposit Mobilization")
  Loan_Follow_up           @map("Loan Follow-up")
  New_Customer             @map("New Customer")
  Digital_Activation       @map("Digital Activation")
  Member_Registration      @map("Member Registration")
  Shareholder_Recruitment  @map("Shareholder Recruitment")
}

enum MappingStatus {
  Mapped_to_You           @map("Mapped to You")
  Mapped_to_Another_Staff @map("Mapped to Another Staff")
  Unmapped
}

enum ApprovalStatus {
  Pending
  Approved
  Rejected
  Requested_Edit @map("Requested Edit")
}

enum EvaluationApprovalStatus {
  Draft
  Pending
  Approved
  Rejected
}

enum PerformancePeriod {
  Daily
  Weekly
  Monthly
  Quarterly
  Annual
}

enum EvaluationPeriod {
  Monthly
  Quarterly
  Annual
}

enum CBSValidationStatus {
  Processing
  Completed
  Failed
  Partial
}

enum DiscrepancyType {
  Amount_Mismatch  @map("Amount Mismatch")
  Missing_in_CBS   @map("Missing in CBS")
  Missing_in_PMS   @map("Missing in PMS")
  Account_Mismatch @map("Account Mismatch")
}

enum PerformanceScoreStatus {
  Draft
  Calculated
  Locked
  Finalized
}

enum PerformanceRating {
  Outstanding
  Very_Good     @map("Very Good")
  Good
  Needs_Support @map("Needs Support")
  Unsatisfactory
}

enum ProductMappingStatus {
  active
  pending
  inactive
}

enum AuditAction {
  Plan_Upload                  @map("Plan Upload")
  Plan_Update                  @map("Plan Update")
  User_Created                 @map("User Created")
  User_Updated                 @map("User Updated")
  User_Deleted                 @map("User Deleted")
  Mapping_Updated              @map("Mapping Updated")
  Mapping_Created              @map("Mapping Created")
  Task_Created                 @map("Task Created")
  Task_Approved                @map("Task Approved")
  Task_Rejected                @map("Task Rejected")
  Approval
  KPI_Framework_Updated        @map("KPI Framework Updated")
  Competency_Framework_Updated @map("Competency Framework Updated")
  CBS_Upload                   @map("CBS Upload")
  CBS_Validation               @map("CBS Validation")
  Behavioral_Evaluation        @map("Behavioral Evaluation")
  Password_Reset               @map("Password Reset")
  Login
  Logout
}

enum AuditEntityType {
  Plan
  User
  Mapping
  Task
  CBS
  Evaluation
  Framework
  System
}

// ============== MODELS ==============

model User {
  id                   String    @id @default(uuid()) @map("_id")
  employeeId           String    @unique
  name                 String
  email                String    @unique
  password             String
  role                 UserRole
  branchId             String?
  branch               Branch?   @relation("BranchUsers", fields: [branchId], references: [id])
  branch_code          String?
  sub_team             String?
  regionId             String?
  region               Region?   @relation("RegionUsers", fields: [regionId], references: [id])
  areaId               String?
  area                 Area?     @relation("AreaUsers", fields: [areaId], references: [id])
  position             Position
  isActive             Boolean   @default(true)
  resetPasswordToken   String?
  resetPasswordExpire  DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // Relations
  createdPlans            Plan[]               @relation("PlanCreator")
  submittedTasks          DailyTask[]          @relation("TaskSubmitter")
  receivedEvaluations     BehavioralEvaluation[] @relation("EvaluatedUser")
  givenEvaluations        BehavioralEvaluation[] @relation("Evaluator")
  performanceScores       PerformanceScore[]
  accountMappings         AccountMapping[]     @relation("MappedToUser")
  createdMappings         AccountMapping[]     @relation("MappingCreator")
  cbsValidations          CBSValidation[]      @relation("CBSUploader")
  juneBalanceImports      JuneBalance[]        @relation("JuneBalanceImporter")
  productKpiMappings      ProductKpiMapping[]  @relation("ProductMapper")
  planShareConfigs        PlanShareConfig[]    @relation("PlanShareCreator")
  updatedPlanShareConfigs PlanShareConfig[]    @relation("PlanShareUpdater")
  auditLogs               AuditLog[]
  staffPlans              StaffPlan[]
  managedRegions          Region[]             @relation("RegionDirector")
  managedAreas            Area[]               @relation("AreaManager")
  managedBranches         Branch[]             @relation("BranchManager")
  managedTeams            Team[]               @relation("TeamManager")
  ledSubTeams             SubTeam[]            @relation("SubTeamLeader")
  subTeamMemberships      SubTeam[]            @relation("SubTeamMembers")
  taskApprovals           TaskApproval[]
  cbsDiscrepancyResolvers CBSDiscrepancy[]     @relation("DiscrepancyResolver")
  evaluationApprovals     EvaluationApproval[]

  @@index([branchId])
  @@index([regionId])
  @@index([areaId])
  @@index([role])
  @@index([position])
  @@map("users")
}

model Region {
  id         String   @id @default(uuid()) @map("_id")
  name       String   @unique
  code       String   @unique
  directorId String?
  director   User?    @relation("RegionDirector", fields: [directorId], references: [id])
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  areas    Area[]
  branches Branch[]
  users    User[]   @relation("RegionUsers")

  @@map("regions")
}

model Area {
  id        String   @id @default(uuid()) @map("_id")
  name      String
  code      String   @unique
  regionId  String
  region    Region   @relation(fields: [regionId], references: [id])
  managerId String?
  manager   User?    @relation("AreaManager", fields: [managerId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  branches Branch[]
  users    User[]   @relation("AreaUsers")

  @@index([regionId])
  @@map("areas")
}

model Branch {
  id        String   @id @default(uuid()) @map("_id")
  name      String
  code      String   @unique
  regionId  String
  region    Region   @relation(fields: [regionId], references: [id])
  areaId    String
  area      Area     @relation(fields: [areaId], references: [id])
  managerId String?
  manager   User?    @relation("BranchManager", fields: [managerId], references: [id])
  address   String?
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  users                 User[]               @relation("BranchUsers")
  teams                 Team[]
  subTeams              SubTeam[]
  plans                 Plan[]
  staffPlans            StaffPlan[]
  dailyTasks            DailyTask[]
  performanceScores     PerformanceScore[]
  behavioralEvaluations BehavioralEvaluation[]
  cbsValidations        CBSValidation[]
  accountMappings       AccountMapping[]

  @@index([regionId])
  @@index([areaId])
  @@map("branches")
}

model Team {
  id        String   @id @default(uuid()) @map("_id")
  name      String
  code      String   @unique
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id])
  managerId String?
  manager   User?    @relation("TeamManager", fields: [managerId], references: [id])
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subTeams SubTeam[]

  @@unique([branchId, code])
  @@index([branchId])
  @@map("teams")
}

model SubTeam {
  id        String   @id @default(uuid()) @map("_id")
  name      String
  code      String   @unique
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id])
  leaderId  String?
  leader    User?    @relation("SubTeamLeader", fields: [leaderId], references: [id])
  members   User[]   @relation("SubTeamMembers")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, code])
  @@index([branchId])
  @@index([teamId])
  @@map("sub_teams")
}

model Plan {
  id           String      @id @default(uuid()) @map("_id")
  branch_code  String
  branchId     String
  branch       Branch      @relation(fields: [branchId], references: [id])
  kpi_category KpiCategory
  period       String
  target_value Float       @default(0)
  target_type  TargetType  @default(incremental)
  status       PlanStatus  @default(Draft)
  createdById  String
  createdBy    User        @relation("PlanCreator", fields: [createdById], references: [id])
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  staffPlans StaffPlan[]

  @@index([branch_code, kpi_category, period])
  @@index([branch_code, period])
  @@index([status])
  @@index([branchId])
  @@map("plans")
}

model StaffPlan {
  id                 String      @id @default(uuid()) @map("_id")
  branchPlanId       String
  branchPlan         Plan        @relation(fields: [branchPlanId], references: [id])
  branch_code        String
  branchId           String
  branch             Branch      @relation(fields: [branchId], references: [id])
  userId             String
  user               User        @relation(fields: [userId], references: [id])
  position           String
  kpi_category       KpiCategory
  period             String
  target_type        TargetType  @default(incremental)
  individual_target  Float       @default(0)
  yearly_target      Float       @default(0)
  monthly_target     Float       @default(0)
  weekly_target      Float       @default(0)
  daily_target       Float       @default(0)
  plan_share_percent Float
  status             PlanStatus  @default(Active)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt

  @@index([userId, kpi_category, period])
  @@index([branch_code, period])
  @@index([branchPlanId])
  @@index([branchId])
  @@map("staff_plans")
}

model PlanShareConfig {
  id                      String      @id @default(uuid()) @map("_id")
  branch_code             String?
  kpi_category            KpiCategory
  share_branch_manager    Float       @default(30)
  share_msm               Float       @default(25)
  share_accountant        Float       @default(13)
  share_mso               Float       @default(32)
  total_percent           Float       @default(0)
  isActive                Boolean     @default(true)
  createdById             String?
  createdBy               User?       @relation("PlanShareCreator", fields: [createdById], references: [id])
  updatedById             String?
  updatedBy               User?       @relation("PlanShareUpdater", fields: [updatedById], references: [id])
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt

  @@index([branch_code, kpi_category])
  @@index([kpi_category, isActive])
  @@map("plan_share_configs")
}

model AccountMapping {
  id                    String        @id @default(uuid()) @map("_id")
  accountNumber         String        @unique
  customerName          String
  accountType           AccountType
  balance               Float         @default(0)
  june_balance          Float         @default(0)
  current_balance       Float         @default(0)
  active_status         Boolean       @default(false)
  last_transaction_date DateTime?
  mappedToId            String
  mappedTo              User          @relation("MappedToUser", fields: [mappedToId], references: [id])
  branchId              String
  branch                Branch        @relation(fields: [branchId], references: [id])
  mappedAt              DateTime      @default(now())
  mappedById            String?
  mappedBy              User?         @relation("MappingCreator", fields: [mappedById], references: [id])
  isAutoBalanced        Boolean       @default(false)
  status                AccountStatus @default(Active)
  notes                 String?
  phoneNumber           String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  // Relations
  dailyTasks DailyTask[]

  @@index([mappedToId, branchId, status])
  @@index([accountNumber])
  @@index([branchId])
  @@map("account_mappings")
}

model DailyTask {
  id                  String         @id @default(uuid()) @map("_id")
  taskType            TaskType
  productType         String?
  accountNumber       String
  accountId           String?
  account             AccountMapping? @relation(fields: [accountId], references: [id])
  amount              Float          @default(0)
  remarks             String?
  evidence            String?
  submittedById       String
  submittedBy         User           @relation("TaskSubmitter", fields: [submittedById], references: [id])
  branchId            String
  branch              Branch         @relation(fields: [branchId], references: [id])
  mappingStatus       MappingStatus
  approvalStatus      ApprovalStatus @default(Pending)
  cbsValidated        Boolean        @default(false)
  cbsValidatedAt      DateTime?
  cbsValidationId     String?
  cbsValidation       CBSValidation? @relation(fields: [cbsValidationId], references: [id])
  taskDate            DateTime       @default(now())
  performanceImpacted Boolean        @default(false)
  performanceImpactedAt DateTime?
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  // Relations
  approvalChain TaskApproval[]

  @@index([submittedById, taskDate])
  @@index([branchId, taskDate])
  @@index([approvalStatus, branchId])
  @@index([cbsValidated, taskDate])
  @@map("daily_tasks")
}

model TaskApproval {
  id         String         @id @default(uuid()) @map("_id")
  taskId     String
  task       DailyTask      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  approverId String
  approver   User           @relation(fields: [approverId], references: [id])
  role       String
  status     ApprovalStatus @default(Pending)
  approvedAt DateTime?
  comments   String?
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  @@index([taskId])
  @@index([approverId])
  @@map("task_approvals")
}

model PerformanceScore {
  id                     String                 @id @default(uuid()) @map("_id")
  userId                 String
  user                   User                   @relation(fields: [userId], references: [id])
  branchId               String
  branch                 Branch                 @relation(fields: [branchId], references: [id])
  period                 PerformancePeriod
  year                   Int
  quarter                Int?
  month                  Int?
  week                   Int?
  day                    Int?
  
  // KPI Scores stored as JSON
  kpiScores              Json                   @default("{}")
  kpiTotalScore          Float                  @default(0)
  behavioralScore        Float                  @default(0)
  behavioralEvaluationId String?
  behavioralEvaluation   BehavioralEvaluation?  @relation(fields: [behavioralEvaluationId], references: [id])
  finalScore             Float                  @default(0)
  rating                 PerformanceRating?
  status                 PerformanceScoreStatus @default(Draft)
  isLocked               Boolean                @default(false)
  lockedAt               DateTime?
  createdAt              DateTime               @default(now())
  updatedAt              DateTime               @updatedAt

  @@index([userId, period, year, month])
  @@index([branchId, period, year])
  @@map("performance_scores")
}

model BehavioralEvaluation {
  id              String                    @id @default(uuid()) @map("_id")
  evaluatedUserId String
  evaluatedUser   User                      @relation("EvaluatedUser", fields: [evaluatedUserId], references: [id])
  evaluatedById   String
  evaluatedBy     User                      @relation("Evaluator", fields: [evaluatedById], references: [id])
  branchId        String
  branch          Branch                    @relation(fields: [branchId], references: [id])
  period          EvaluationPeriod
  year            Int
  quarter         Int?
  month           Int?
  
  // Competencies stored as JSON
  competencies    Json                      @default("{}")
  totalScore      Float                     @default(0)
  overallComments String?
  approvalStatus  EvaluationApprovalStatus  @default(Draft)
  isLocked        Boolean                   @default(false)
  lockedAt        DateTime?
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  // Relations
  approvalChain     EvaluationApproval[]
  performanceScores PerformanceScore[]

  @@index([evaluatedUserId, period, year, month])
  @@index([branchId, approvalStatus])
  @@map("behavioral_evaluations")
}

model EvaluationApproval {
  id           String                   @id @default(uuid()) @map("_id")
  evaluationId String
  evaluation   BehavioralEvaluation     @relation(fields: [evaluationId], references: [id], onDelete: Cascade)
  approverId   String
  approver     User                     @relation(fields: [approverId], references: [id])
  role         String
  status       EvaluationApprovalStatus @default(Pending)
  approvedAt   DateTime?
  comments     String?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  @@index([evaluationId])
  @@index([approverId])
  @@map("evaluation_approvals")
}

model CBSValidation {
  id               String              @id @default(uuid()) @map("_id")
  branchId         String
  branch           Branch              @relation(fields: [branchId], references: [id])
  validationDate   DateTime
  fileName         String
  filePath         String
  uploadedById     String
  uploadedBy       User                @relation("CBSUploader", fields: [uploadedById], references: [id])
  totalRecords     Int                 @default(0)
  matchedRecords   Int                 @default(0)
  unmatchedRecords Int                 @default(0)
  discrepancyCount Int                 @default(0)
  status           CBSValidationStatus @default(Processing)
  validatedAt      DateTime?
  validationRate   Float               @default(0)
  
  // Unmapped products stored as JSON
  unmappedProducts Json                @default("[]")
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  // Relations
  discrepancies CBSDiscrepancy[]
  dailyTasks    DailyTask[]

  @@index([branchId, validationDate])
  @@index([status])
  @@map("cbs_validations")
}

model CBSDiscrepancy {
  id              String          @id @default(uuid()) @map("_id")
  validationId    String
  validation      CBSValidation   @relation(fields: [validationId], references: [id], onDelete: Cascade)
  accountNumber   String
  taskId          String?
  cbsAmount       Float?
  pmsAmount       Float?
  difference      Float?
  type            DiscrepancyType
  resolved        Boolean         @default(false)
  resolvedById    String?
  resolvedBy      User?           @relation("DiscrepancyResolver", fields: [resolvedById], references: [id])
  resolvedAt      DateTime?
  resolutionNotes String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  @@index([validationId])
  @@map("cbs_discrepancies")
}

model JuneBalance {
  id              String    @id @default(uuid()) @map("_id")
  account_id      String
  accountNumber   String?
  june_balance    Float     @default(0)
  branch_code     String?
  baseline_period String    @default("2025")
  baseline_date   DateTime
  is_active       Boolean   @default(true)
  importedAt      DateTime  @default(now())
  importedById    String?
  importedBy      User?     @relation("JuneBalanceImporter", fields: [importedById], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([account_id, baseline_period])
  @@index([accountNumber, baseline_period])
  @@index([branch_code])
  @@index([baseline_period, is_active])
  @@map("june_balances")
}

model ProductKpiMapping {
  id               String               @id @default(uuid()) @map("_id")
  cbs_product_name String               @unique
  kpi_category     KpiCategory
  min_balance      Float                @default(0)
  status           ProductMappingStatus @default(active)
  mappedById       String
  mappedBy         User                 @relation("ProductMapper", fields: [mappedById], references: [id])
  mapped_at        DateTime             @default(now())
  notes            String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt

  @@index([cbs_product_name, status])
  @@index([kpi_category, status])
  @@map("product_kpi_mappings")
}

model AuditLog {
  id         String          @id @default(uuid()) @map("_id")
  userId     String
  user       User            @relation(fields: [userId], references: [id])
  action     AuditAction
  entityType AuditEntityType?
  entityId   String?
  entityName String?
  details    String?
  ipAddress  String?
  userAgent  String?
  metadata   Json?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
